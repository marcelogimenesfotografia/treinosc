<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Rachão Santa Casa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f5;
            --card-bg-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-color: #eab308;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary); }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.05);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: #f9fafb;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #d99f07; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .modal { display: none; position: fixed; inset: 0; z-index: 50; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.7); }
        .modal.is-open { display: flex; }
        .participant-list {
            height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .participant-item:hover {
            background-color: #f3f4f6;
        }
        .admin-menu-item {
            display: block;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .admin-menu-item:hover {
            background-color: #f3f4f6;
            color: var(--text-primary);
        }
        .admin-menu-item.active {
            background-color: var(--accent-color);
            color: white;
        }
        .log-change {
            background-color: #f9fafb;
            border-left: 4px solid var(--border-color);
            padding: 0.5rem 1rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-change code {
            white-space: pre-wrap;
            word-break: break-all;
        }
        #noticia-editor {
            height: 300px;
            background-color: white;
        }
        /* Estilo para o Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Tela de Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="card w-full max-w-sm">
            <img src="https://marcelogimenesfotografia.github.io/rachaosantacasa/logorachao.png" alt="Logo" class="w-48 mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-6">Acesso Restrito</h2>
            <form id="login-form" class="space-y-4">
                 <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Palavra-passe</label>
                    <input type="password" id="password" class="input-field mt-1" required>
                </div>
                <div class="flex items-center justify-between">
                    <label class="flex items-center text-sm text-gray-700">
                        <input id="remember-me" type="checkbox" class="rounded border-gray-300 text-yellow-500 shadow-sm focus:border-yellow-300 focus:ring focus:ring-yellow-200 focus:ring-opacity-50">
                        <span class="ml-2">Lembrar-me</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary w-full">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Painel Principal (escondido por padrão) -->
    <div id="dashboard-section" class="hidden max-w-7xl mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-10">
            <h1 class="text-3xl font-bold">Painel de Administração</h1>
            <button id="logout-btn" class="btn btn-secondary">Sair</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <!-- Menu Lateral -->
            <div class="md:col-span-1">
                <div class="card p-4">
                    <ul id="admin-menu" class="space-y-1">
                        <li><a href="#" data-target="section-resultados" class="admin-menu-item"><i class="fas fa-trophy w-6 mr-2"></i>Resultados</a></li>
                        <li><a href="#" data-target="section-meses" class="admin-menu-item"><i class="fas fa-calendar-alt w-6 mr-2"></i>Gerir Meses</a></li>
                        <li><a href="#" data-target="section-participantes" class="admin-menu-item"><i class="fas fa-users w-6 mr-2"></i>Participantes</a></li>
                        <li><a href="#" data-target="section-equipes" class="admin-menu-item"><i class="fas fa-shield-alt w-6 mr-2"></i>Equipes</a></li>
                        <li><a href="#" data-target="section-noticias" class="admin-menu-item"><i class="fas fa-newspaper w-6 mr-2"></i>Notícias</a></li>
                        <li><a href="#" data-target="section-menu" class="admin-menu-item"><i class="fas fa-bars w-6 mr-2"></i>Gerir Menu</a></li>
                        <li><a href="#" data-target="section-config" class="admin-menu-item"><i class="fas fa-cog w-6 mr-2"></i>Configurações</a></li>
                        <li><a href="#" data-target="section-logs" class="admin-menu-item"><i class="fas fa-clipboard-list w-6 mr-2"></i>Logs</a></li>
                    </ul>
                </div>
            </div>

            <!-- Área de Conteúdo -->
            <div class="md:col-span-3">
                
                <!-- Seção Gerir Resultados -->
                <div id="section-resultados" class="admin-section">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Resultados</h2>
                        <div class="flex flex-wrap gap-4 items-center mb-6">
                            <select id="month-select-admin" class="input-field flex-grow"></select>
                            <button id="new-month-btn" class="btn btn-secondary">Novo Mês</button>
                        </div>

                        <!-- Grid de Cards das Etapas -->
                        <div id="stages-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>

                        <div class="mt-6 border-t pt-6">
                            <div class="space-y-4 my-4">
                                <div>
                                    <label for="geral_podium_img" class="font-medium text-sm">URL da Foto da Classificação Geral</label>
                                    <input type="url" id="geral_podium_img" class="input-field mt-1" placeholder="https://...">
                                </div>
                                <div>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="month-completed-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                                        <span class="font-medium">Mês Concluído (exibir pódio)</span>
                                    </label>
                                </div>
                            </div>
                            <button id="save-month-settings-btn" class="btn btn-primary w-full">Guardar Configurações do Mês</button>
                        </div>
                    </div>
                </div>

                <!-- Seção Gerir Meses (NOVA) -->
                <div id="section-meses" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Meses</h2>
                        <p class="text-gray-500 text-sm mb-6">Aqui pode editar os nomes dos meses, ocultá-los do site público ou excluí-los permanentemente.</p>
                        <div id="months-list-container" class="space-y-4">
                            <!-- Lista de meses será injetada aqui -->
                        </div>
                    </div>
                </div>
                
                <!-- Seção Gerir Participantes -->
                <div id="section-participantes" class="admin-section hidden">
                     <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Participantes</h2>
                        <form id="add-participant-form" class="space-y-3 mb-6">
                            <input id="participant-name" type="text" placeholder="Nome de Exibição (Apelido)" class="input-field" required>
                            <input id="participant-fullname" type="text" placeholder="Nome Completo" class="input-field" required>
                            <select id="participant-team" class="input-field"></select>
                            <div>
                                <label for="participant-image-filename" class="font-medium text-sm">Nome do Ficheiro da Foto</label>
                                <input id="participant-image-filename" type="text" placeholder="ex: joao.jpg" class="input-field mt-1">
                                <p class="text-xs text-gray-500 mt-1">O ficheiro deve estar na pasta configurada.</p>
                            </div>
                             <div>
                                <label for="participant-strava" class="font-medium text-sm">Link do Strava</label>
                                <input id="participant-strava" type="text" placeholder="Link completo ou apenas ID do atleta" class="input-field mt-1">
                            </div>
                             <div>
                                <label for="participant-instagram" class="font-medium text-sm">Link do Instagram</label>
                                <input id="participant-instagram" type="text" placeholder="Link completo ou apenas @utilizador" class="input-field mt-1">
                            </div>
                             <div>
                                <label for="participant-facebook" class="font-medium text-sm">Link do Facebook</label>
                                <input id="participant-facebook" type="text" placeholder="Link completo ou nome de utilizador" class="input-field mt-1">
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Adicionar Participante</button>
                        </form>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="filter-team" class="font-medium text-sm">Filtrar por Equipe</label>
                                <select id="filter-team" class="input-field mt-1"></select>
                            </div>
                            <div>
                                <label for="filter-name" class="font-medium text-sm">Filtrar por Nome</label>
                                <input id="filter-name" type="text" placeholder="Digite o nome..." class="input-field mt-1">
                            </div>
                        </div>
                        <div id="participants-list" class="space-y-2"></div>
                    </div>
                </div>
                
                 <!-- Seção Gerir Equipes -->
                <div id="section-equipes" class="admin-section hidden">
                     <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Equipes</h2>
                        <form id="add-team-form" class="space-y-3 mb-6">
                            <label for="new-team-name" class="font-medium text-sm">Nome da Nova Equipe</label>
                            <input id="new-team-name" type="text" placeholder="Nome da Equipe" class="input-field" required>
                            <button type="submit" class="btn btn-primary w-full">Adicionar Equipe</button>
                        </form>
                        <div id="teams-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Seção Gerir Notícias -->
                <div id="section-noticias" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Notícias</h2>
                        <form id="add-noticia-form" class="space-y-3 mb-6">
                            <input id="noticia-id" type="hidden"> <!-- For editing -->
                            <input id="noticia-title" type="text" placeholder="Título da Matéria" class="input-field" required>
                            <input id="noticia-image" type="url" placeholder="URL da Imagem de Destaque" class="input-field" required>
                            <div id="noticia-editor"></div>
                            <button type="submit" class="btn btn-primary w-full mt-4">Publicar Notícia</button>
                        </form>
                        <h3 class="text-lg font-bold mt-8 mb-4 border-t pt-4">Notícias Publicadas</h3>
                        <div id="noticias-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Seção Gerir Menu -->
                <div id="section-menu" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Gerir Menu Principal</h2>
                        <p class="text-gray-600 mb-6">Controle quais páginas devem aparecer no menu de navegação do site público.</p>
                        <div id="menu-management-list" class="space-y-4">
                            <!-- Itens do menu serão carregados aqui -->
                        </div>
                        <button id="save-menu-btn" class="btn btn-primary w-full mt-6">Guardar Alterações do Menu</button>
                    </div>
                </div>

                <!-- Seção Configurações -->
                <div id="section-config" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Configurações Gerais</h2>
                        <div class="space-y-3">
                            <div>
                                <label for="image-base-url" class="font-medium text-sm">URL Base das Imagens</label>
                                <input id="image-base-url" type="url" placeholder="https://..." class="input-field mt-1">
                                <p class="text-xs text-gray-500 mt-1">Caminho da pasta onde as fotos estão guardadas (terminar com /).</p>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <span class="font-medium">Exibir Nomes das Equipes no Site</span>
                                <label class="switch">
                                    <input type="checkbox" id="show-team-names">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <button id="save-settings-btn" class="btn btn-primary w-full">Guardar Configurações</button>
                        </div>
                    </div>
                </div>
                
                <!-- Seção Logs -->
                <div id="section-logs" class="admin-section hidden">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">Registro de Atividades (Logs)</h2>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="log-filter-action" class="font-medium text-sm">Filtrar por Ação</label>
                                <select id="log-filter-action" class="input-field mt-1"></select>
                            </div>
                            <div>
                                <label for="log-filter-text" class="font-medium text-sm">Buscar no Detalhe</label>
                                <input id="log-filter-text" type="text" placeholder="Digite para buscar..." class="input-field mt-1">
                            </div>
                        </div>
                        <div id="logs-list" class="space-y-2 text-sm text-gray-600 max-h-[40rem] overflow-y-auto"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="edit-participant-modal" class="modal">
        <div class="card w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Editar Participante</h2>
                <button onclick="closeModal('edit-participant-modal')" class="text-2xl">&times;</button>
            </div>
            <form id="edit-participant-form" class="space-y-3">
                <input type="hidden" id="edit-participant-id">
                <div>
                    <label for="edit-participant-name" class="font-medium">Nome de Exibição (Apelido)</label>
                    <input id="edit-participant-name" type="text" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="edit-participant-fullname" class="font-medium">Nome Completo</label>
                    <input id="edit-participant-fullname" type="text" class="input-field mt-1" required>
                </div>
                <div>
                    <label for="edit-participant-team" class="font-medium">Equipe</label>
                    <select id="edit-participant-team" class="input-field mt-1"></select>
                </div>
                <div id="team-change-options" class="hidden space-y-2 border-t pt-4">
                    <div>
                        <label for="transfer-date" class="font-medium text-sm">Data da Transferência/Correção</label>
                        <input id="transfer-date" type="date" class="input-field mt-1">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                             <input type="checkbox" id="correction-checkbox" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                             <span class="text-sm">Apenas corrigir (alterar todo o histórico)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="edit-participant-image-filename" class="font-medium">Nome do Ficheiro da Foto</label>
                    <input id="edit-participant-image-filename" type="text" class="input-field mt-1" placeholder="ex: joao.jpg">
                     <p class="text-xs text-gray-500 mt-1">O ficheiro deve estar na pasta configurada.</p>
                </div>
                <div>
                    <label for="edit-participant-strava" class="font-medium text-sm">Link do Strava</label>
                    <input id="edit-participant-strava" type="text" placeholder="Link completo ou apenas ID do atleta" class="input-field mt-1">
                </div>
                 <div>
                    <label for="edit-participant-instagram" class="font-medium text-sm">Link do Instagram</label>
                    <input id="edit-participant-instagram" type="text" placeholder="Link completo ou apenas @utilizador" class="input-field mt-1">
                </div>
                 <div>
                    <label for="edit-participant-facebook" class="font-medium text-sm">Link do Facebook</label>
                    <input id="edit-participant-facebook" type="text" placeholder="Link completo ou nome de utilizador" class="input-field mt-1">
                </div>
                <div class="pt-2">
                    <label class="flex items-center gap-2">
                         <input type="checkbox" id="edit-participant-sporadic" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-500">
                         <span class="font-medium">Marcar como participante esporádico (não pontua)</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                     <button type="button" onclick="closeModal('edit-participant-modal')" class="btn btn-secondary">Cancelar</button>
                     <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-options-modal" class="modal">
        <div class="card w-full max-w-lg">
            <h2 class="text-xl font-bold mb-2">Como deseja remover <span id="delete-participant-name" class="text-yellow-600"></span>?</h2>
            <p class="text-gray-600 mb-6">Pode desativar o participante para o remover das listas, mas manter o seu histórico, ou excluí-lo permanentemente.</p>
            
            <div class="space-y-4">
                <div class="p-4 border rounded-lg">
                    <h3 class="font-semibold">Desativar Participante (Recomendado)</h3>
                    <p class="text-sm text-gray-500 mb-3">O participante será removido das listas de seleção, mas o seu nome e resultados históricos continuarão a aparecer nas classificações antigas.</p>
                    <button id="deactivate-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white w-full">Desativar</button>
                </div>
                <div class="p-4 border rounded-lg border-red-200 bg-red-50">
                     <h3 class="font-semibold text-red-700">Excluir Permanente</h3>
                    <p class="text-sm text-gray-500 mb-3">O participante e todo o seu histórico de resultados serão apagados para sempre. Esta ação não pode ser desfeita.</p>
                    <button id="hard-delete-btn" class="btn bg-red-600 hover:bg-red-700 text-white w-full">Excluir Permanente</button>
                </div>
            </div>

            <div class="mt-6 text-center">
                 <button id="cancel-delete-options-btn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Universal Modals -->
    <div id="info-modal" class="modal">
        <div class="card w-full max-w-sm text-center">
            <p id="info-modal-text" class="mb-6"></p>
            <button id="info-modal-close" class="btn btn-primary">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="card w-full max-w-sm text-center">
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-modal-ok" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="prompt-modal" class="modal">
        <div class="card w-full max-w-sm">
            <p id="prompt-modal-text" class="mb-4 font-medium"></p>
            <input id="prompt-modal-input" type="text" class="input-field mb-4">
            <div class="flex justify-end gap-4">
                <button id="prompt-modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="prompt-modal-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <div id="log-details-modal" class="modal">
        <div class="card w-full max-w-3xl">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Detalhes do Log</h2>
                <button onclick="closeModal('log-details-modal')" class="text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-semibold mb-2">Antes</h3>
                    <div class="log-change"><code><pre id="log-details-before" class="whitespace-pre-wrap"></pre></code></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Depois</h3>
                    <div class="log-change"><code><pre id="log-details-after" class="whitespace-pre-wrap"></pre></code></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Alterar Status da Etapa -->
    <div id="status-stage-modal" class="modal">
        <div class="card w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Alterar Status da Etapa</h2>
                <button onclick="closeModal('status-stage-modal')" class="text-2xl">&times;</button>
            </div>
            <form id="status-stage-form" class="space-y-3">
                <input type="hidden" id="status-stage-id">
                <div>
                    <label for="stage-status-select" class="font-medium">Novo Status</label>
                    <select id="stage-status-select" class="input-field mt-1">
                        <option value="A realizar">A realizar</option>
                        <option value="Realizada">Realizada</option>
                        <option value="Cancelada">Cancelada</option>
                        <option value="Adiada">Adiada</option>
                    </select>
                </div>
                <div>
                    <label for="stage-motive" class="font-medium">Motivo (opcional)</label>
                    <textarea id="stage-motive" class="input-field mt-1" rows="3" placeholder="Descreva o motivo do cancelamento ou adiamento..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                     <button type="button" onclick="closeModal('status-stage-modal')" class="btn btn-secondary">Cancelar</button>
                     <button type="submit" class="btn btn-primary">Salvar Status</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal para Editar Etapa -->
    <div id="stage-edit-modal" class="modal">
        <div class="card w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="stage-modal-title" class="text-xl font-bold">Editar Etapa</h2>
                <button onclick="closeModal('stage-edit-modal')" class="text-2xl">&times;</button>
            </div>
            <form id="stage-edit-form" class="space-y-3 overflow-y-auto pr-2">
                <input type="hidden" id="edit-stage-id">
                <input type="hidden" id="edit-stage-month-id">
                <input type="hidden" id="edit-stage-index">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" placeholder="Nome da Etapa" class="input-field" id="edit-stage-name">
                    <input type="date" class="input-field" id="edit-stage-date">
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <select class="input-field" id="edit-stage-type">
                        <option value="">Selecione o tipo</option>
                        <option value="Circuito">Circuito</option>
                        <option value="Estrada">Estrada</option>
                        <option value="Crono">Crono</option>
                    </select>
                    <input type="text" placeholder="Duração/Distância" class="input-field" id="edit-stage-duration-distance">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <label class="font-medium text-sm block mb-1">Participantes Disponíveis</label>
                        <input type="text" placeholder="Filtrar..." class="input-field mb-2" id="edit-stage-filter">
                        <div class="participant-list" id="edit-stage-available-list"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm block mb-1">Classificação da Etapa</label>
                        <div class="participant-list" id="edit-stage-classified-list"></div>
                    </div>
                </div>

                <label class="font-medium text-sm mt-3 block">URL da Foto do Pódio</label>
                <input type="url" class="input-field mt-1" id="edit-stage-podium-img">
                
                <div class="flex items-center justify-between mt-4">
                    <div id="stage-status-buttons" class="flex gap-2">
                        <!-- Botões de status serão inseridos aqui via JS -->
                    </div>
                    <button type="button" class="btn-danger text-sm py-1 px-2" id="remove-stage-btn">Remover Etapa</button>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t">
                     <button type="button" onclick="closeModal('stage-edit-modal')" class="btn btn-secondary">Cancelar</button>
                     <button type="submit" class="btn btn-primary">Salvar Etapa</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Moderação de Comentários -->
    <div id="comments-modal" class="modal">
        <div class="card w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Moderar Comentários</h2>
                <button onclick="closeModal('comments-modal')" class="text-2xl">&times;</button>
            </div>
            <div id="comments-list-container" class="overflow-y-auto space-y-3">
                <!-- Comentários para moderação serão inseridos aqui -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, getDocs, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp, Timestamp, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWsgx2mSOPwNwWBwl373DJ3oj7VuFwy9Y",
            authDomain: "rachaosc.firebaseapp.com",
            projectId: "rachaosc",
            storageBucket: "rachaosc.appspot.com",
            messagingSenderId: "28309536958",
            appId: "1:28309536958:web:eac51586cdabd82f691eef"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Variáveis Globais de Estado ---
        let participantsData = {};
        let nameToIdMap = {};
        let monthlyData = {};
        let sporadicRiders = [];
        let teamsData = {};
        let imageBaseUrl = '';
        let showTeamNames = true;
        let dashboardInitialized = false;
        let allLogs = [];
        let filteredLogs = [];
        let noticiasData = [];
        let menuSettings = {};
        let quill;
        
        // --- HOISTED FUNCTIONS (Declared first to avoid reference errors) ---
        
        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            if (!dashboardInitialized) {
                setupDashboardEventListeners();
                dashboardInitialized = true;
            }
            loadAllData();
        }

        function showLogin() {
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('dashboard-section').style.display = 'none';
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                // Attach submit listener here to ensure it's ready
                loginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const rememberMe = document.getElementById('remember-me').checked;
                    
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;

                    try { 
                        await setPersistence(auth, persistence);
                        await signInWithEmailAndPassword(auth, email, password); 
                    } catch (error) { 
                        console.error("Erro no login:", error);
                        openInfoModal('Email ou palavra-passe incorreta!'); 
                    }
                };
            }
        }
        
        function openModal(id) { document.getElementById(id).classList.add('is-open'); }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('is-open'); }

        function openInfoModal(text) {
            document.getElementById('info-modal-text').textContent = text;
            openModal('info-modal');
        }

        function openConfirmModal(text) {
            return new Promise((resolve) => {
                document.getElementById('confirm-modal-text').textContent = text;
                openModal('confirm-modal');
                document.getElementById('confirm-modal-ok').onclick = () => { closeModal('confirm-modal'); resolve(true); };
                document.getElementById('confirm-modal-cancel').onclick = () => { closeModal('confirm-modal'); resolve(false); };
            });
        }

        async function openPromptModal(text, defaultValue = '') {
            return new Promise((resolve) => {
                document.getElementById('prompt-modal-text').textContent = text;
                const input = document.getElementById('prompt-modal-input');
                input.value = defaultValue;
                openModal('prompt-modal');
                const okHandler = () => { closeModal('prompt-modal'); resolve(input.value); };
                const cancelHandler = () => { closeModal('prompt-modal'); resolve(null); };
                document.getElementById('prompt-modal-ok').onclick = okHandler;
                document.getElementById('prompt-modal-cancel').onclick = cancelHandler;
            });
        }
        
        function openLogDetailsModal(logIndex) {
            const log = filteredLogs[logIndex];
            if (!log) return;
            document.getElementById('log-details-before').textContent = log.before ? JSON.stringify(JSON.parse(log.before), null, 2) : 'N/A';
            document.getElementById('log-details-after').textContent = log.after ? JSON.stringify(JSON.parse(log.after), null, 2) : 'N/A';
            openModal('log-details-modal');
        }
        
        function openDeleteOptionsModal(id) {
            const participantName = participantsData[id]?.name;
            if (!participantName) return;
            document.getElementById('delete-participant-name').textContent = participantName.toUpperCase();
            
            const deactivateBtn = document.getElementById('deactivate-btn');
            const hardDeleteBtn = document.getElementById('hard-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-options-btn');

            deactivateBtn.onclick = () => deactivateParticipant(id);
            hardDeleteBtn.onclick = () => hardDeleteParticipant(id);
            cancelBtn.onclick = () => closeModal('delete-options-modal');
            openModal('delete-options-modal');
        }

        function normalizeSocialLink(input, platform) {
            let cleanInput = (input || '').trim();
            if (!cleanInput) return '';
            cleanInput = cleanInput.split('?')[0];
            if (cleanInput.endsWith('/')) cleanInput = cleanInput.slice(0, -1);
            let baseUrl = '', identifier = '';
            switch (platform) {
                case 'strava': baseUrl = 'https://www.strava.com/athletes/'; if (/^\d+$/.test(cleanInput)) return baseUrl + cleanInput; identifier = cleanInput.split('athletes/')[1]; if (identifier) return baseUrl + identifier.split('/')[0]; break;
                case 'instagram': baseUrl = 'https://www.instagram.com/'; cleanInput = cleanInput.replace(/^@/, ''); identifier = cleanInput.split('instagram.com/')[1]; if (identifier) return baseUrl + identifier.split('/')[0]; return baseUrl + cleanInput;
                case 'facebook': baseUrl = 'https://www.facebook.com/'; identifier = cleanInput.split('facebook.com/')[1]; if (identifier) return baseUrl + identifier.split('/')[0]; return baseUrl + cleanInput;
            }
            return input; 
        }
        
        async function deactivateParticipant(id) {
            const participant = participantsData[id];
            if (!participant) return;
            if (await openConfirmModal(`Tem a certeza que deseja DESATIVAR ${participant.name.toUpperCase()}? Ele será removido das listas, mas o seu histórico será mantido.`)) {
                try {
                    const participantRef = doc(db, 'participants', id);
                    await updateDoc(participantRef, { isActive: false });
                    await logAction('PARTICIPANT_DEACTIVATED', `Participante "${participant.name}" foi desativado.`);
                    closeModal('delete-options-modal');
                    openInfoModal('Participante desativado com sucesso.');
                    await loadAllData();
                } catch (error) {
                    console.error("Erro ao desativar participante:", error);
                    openInfoModal("Ocorreu um erro ao desativar o participante.");
                }
            }
        }

        async function hardDeleteParticipant(id) {
            const participant = participantsData[id];
            if (!participant) return;
            if (await openConfirmModal(`ATENÇÃO: Exclusão permanente! Tem a certeza ABSOLUTA?`)) {
                try {
                    await deleteDoc(doc(db, 'participants', id));
                    await logAction('PARTICIPANT_DELETED', `Participante "${participant.name}" foi permanentemente excluído.`);
                    closeModal('delete-options-modal');
                    openInfoModal('Participante excluído permanentemente com sucesso.');
                    await loadAllData();
                } catch (error) {
                    console.error("Erro ao excluir participante:", error);
                    openInfoModal("Ocorreu um erro ao excluir o participante.");
                }
            }
        }
        
        async function logAction(action, details, before, after) {
            if (!auth.currentUser) return;
            try {
                 const logEntry = {
                    timestamp: serverTimestamp(),
                    adminEmail: auth.currentUser.email,
                    action: action,
                    details: details,
                };
                if (before) logEntry.before = JSON.stringify(before, null, 2);
                if (after) logEntry.after = JSON.stringify(after, null, 2);
                await addDoc(collection(db, 'logs'), logEntry);
            } catch (error) { console.error("Erro ao gravar log:", error); }
        }
        
        function getThursdays(year, month) {
            const thursdays = [];
            const date = new Date(year, month - 1, 1);
            while (date.getMonth() === month - 1) {
                if (date.getDay() === 4) { thursdays.push(new Date(date.getTime())); }
                date.setDate(date.getDate() + 1);
            }
            return thursdays.map(d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`);
        }

        function renderTeamSelectors(newTeamToSelect = '') {
            const selects = [document.getElementById('participant-team'), document.getElementById('edit-participant-team'), document.getElementById('filter-team')];
            const sortedTeams = Object.entries(teamsData).filter(([id, team]) => team.isActive !== false).sort((a,b) => a[1].name.localeCompare(b[1].name));
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = select.id === 'filter-team' ? '<option value="">Todas as Equipes</option>' : '<option value="">Selecionar equipe</option>';
                sortedTeams.forEach(([id, team]) => { select.add(new Option(team.name, id)); });
                if(select.id !== 'filter-team') { select.add(new Option("--- Criar nova equipe ---", "new_team")); }
                select.value = newTeamToSelect || '';
            });
        }
        
        async function handleTeamSelection(selectElementId) {
            const select = document.getElementById(selectElementId);
            if (select.value === 'new_team') {
                const newTeam = await openPromptModal("Digite o nome da nova equipe:");
                if (newTeam && newTeam.trim()) {
                    try {
                        const newDocRef = doc(collection(db, 'teams'));
                        await setDoc(newDocRef, { name: newTeam.trim(), isActive: true, createdAt: serverTimestamp() });
                        await logAction('TEAM_CREATED', `Equipe "${newTeam.trim()}" criada.`);
                        teamsData[newDocRef.id] = { name: newTeam.trim() };
                        renderTeamSelectors(newDocRef.id);
                        renderTeamsList();
                    } catch(e) { console.error(e); openInfoModal("Erro ao criar equipe."); }
                } else { select.value = ''; }
            }
        }
        
        function renderLogs() {
            const list = document.getElementById('logs-list');
            const actionFilter = document.getElementById('log-filter-action').value;
            const textFilter = document.getElementById('log-filter-text').value.toLowerCase();
            list.innerHTML = '';
            filteredLogs = allLogs.filter(log => {
                const actionMatch = !actionFilter || log.action === actionFilter;
                const textMatch = !textFilter || (log.details && log.details.toLowerCase().includes(textFilter));
                return actionMatch && textMatch;
            });
            if (filteredLogs.length === 0) { list.innerHTML = '<p>Nenhuma atividade encontrada.</p>'; return; }
            const actionTypes = [...new Set(allLogs.map(l => l.action))].sort();
            const filterSelect = document.getElementById('log-filter-action');
            if (filterSelect.options.length <= 1) { actionTypes.forEach(action => filterSelect.add(new Option(action, action))); }
            filteredLogs.forEach((log, index) => {
                const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString('pt-BR') : 'Data inválida';
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-50 rounded-md border-l-4 border-gray-300';
                div.innerHTML = `<div class="flex justify-between items-center cursor-pointer" data-log-index="${index}"><div><p><strong class="font-semibold">${log.details}</strong></p><p class="text-xs text-gray-400">${log.adminEmail} em ${date}</p></div><i class="fas fa-eye text-gray-400"></i></div>`;
                list.appendChild(div);
            });
        }

        function renderParticipants() {
            const list = document.getElementById('participants-list');
            const filterTeamId = document.getElementById('filter-team').value;
            const filterName = document.getElementById('filter-name').value.toLowerCase();
            list.innerHTML = '';
            const sortedParticipants = Object.entries(participantsData).filter(([id, p]) => p.isActive !== false).sort((a, b) => a[1].name.localeCompare(b[1].name));
            const filteredParticipants = sortedParticipants.filter(([id, p]) => {
                const teamHistory = p.teamHistory || [];
                const currentTeamId = teamHistory.length > 0 ? teamHistory[teamHistory.length - 1].teamId : '';
                return (!filterTeamId || currentTeamId === filterTeamId) && p.name.toLowerCase().includes(filterName);
            });
            if (filteredParticipants.length === 0) { list.innerHTML = '<p class="text-center text-gray-500">Nenhum participante encontrado.</p>'; return; }
            filteredParticipants.forEach(([id, participant]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                const isSporadic = sporadicRiders.includes(id);
                div.innerHTML = `<div><span class="font-medium">${participant.name.toUpperCase()}</span>${isSporadic ? '<span class="ml-2 text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded-full">ESPORÁDICO</span>' : ''}</div><div class="space-x-2"><button class="text-blue-500 edit-p-btn" data-id="${id}"><i class="fas fa-edit"></i></button><button class="text-red-500 del-p-btn" data-id="${id}"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(div);
            });
             document.querySelectorAll('.edit-p-btn').forEach(b => b.onclick = () => openEditParticipant(b.dataset.id));
             document.querySelectorAll('.del-p-btn').forEach(b => b.onclick = () => openDeleteOptionsModal(b.dataset.id));
        }
        
        function openEditParticipant(id) {
            const p = participantsData[id];
            const teamHistory = p.teamHistory || [];
            participantOriginalTeam = teamHistory.length > 0 ? teamHistory[teamHistory.length - 1].teamId : '';
            document.getElementById('edit-participant-id').value = id;
            document.getElementById('edit-participant-name').value = p.name;
            document.getElementById('edit-participant-fullname').value = p.fullName || '';
            document.getElementById('edit-participant-team').value = participantOriginalTeam;
            document.getElementById('edit-participant-image-filename').value = p.imageUrl || '';
            document.getElementById('edit-participant-strava').value = p.strava || '';
            document.getElementById('edit-participant-instagram').value = p.instagram || '';
            document.getElementById('edit-participant-facebook').value = p.facebook || '';
            document.getElementById('edit-participant-sporadic').checked = sporadicRiders.includes(id);
            document.getElementById('team-change-options').classList.add('hidden');
            openModal('edit-participant-modal');
        }
        
        function renderMonthSelector() {
            const select = document.getElementById('month-select-admin');
            select.innerHTML = '';
            const allMonthIds = new Set(Object.keys(monthlyData));
            const currentDate = new Date();
            const currentMonthId = `${currentDate.getFullYear()}_${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            allMonthIds.add(currentMonthId);
            [...allMonthIds].sort().reverse().forEach(id => { select.add(new Option(monthlyData[id] ? monthlyData[id].title : `${id} (Novo)`, id)); });
            select.value = currentMonthId;
        }
        
        function renderTeamsList() {
            const list = document.getElementById('teams-list');
            list.innerHTML = '';
            const sortedTeams = Object.entries(teamsData).filter(([id, team]) => team.isActive !== false).sort((a, b) => a[1].name.localeCompare(b[1].name));
            if (sortedTeams.length === 0) { list.innerHTML = '<p class="text-center text-gray-500">Nenhuma equipe cadastrada.</p>'; return; }
            sortedTeams.forEach(([id, team]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                div.innerHTML = `<span class="font-medium">${team.name}</span><div class="space-x-2"><button class="text-blue-500 edit-t-btn" data-id="${id}"><i class="fas fa-edit"></i></button><button class="text-red-500 del-t-btn" data-id="${id}"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(div);
            });
        }

        function renderNoticias() {
            const list = document.getElementById('noticias-list');
            list.innerHTML = '';
            if (noticiasData.length === 0) { list.innerHTML = '<p class="text-center text-gray-500">Nenhuma notícia.</p>'; return; }
            noticiasData.forEach(noticia => {
                const date = noticia.createdAt?.toDate ? noticia.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data inválida';
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                div.innerHTML = `<div><span class="font-medium">${noticia.title}</span><p class="text-xs text-gray-500">${date}</p></div><div class="space-x-2"><button class="text-gray-500 hover:text-gray-700 moderate-comments-btn" data-id="${noticia.id}"><i class="fas fa-comments"></i></button><button class="text-blue-500 hover:text-blue-700 edit-n-btn" data-id="${noticia.id}"><i class="fas fa-edit"></i></button><button class="text-red-500 hover:text-red-700 del-n-btn" data-id="${noticia.id}"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(div);
            });
        }

        // Renderização dos MESES (NOVA FUNÇÃO)
        function renderMonthsList() {
            const list = document.getElementById('months-list-container');
            list.innerHTML = '';
            
            const sortedMonths = Object.entries(monthlyData).sort((a,b) => b[0].localeCompare(a[0])); // ID reverse sort
            
            if(sortedMonths.length === 0) {
                list.innerHTML = '<p class="text-gray-500">Nenhum mês registado.</p>';
                return;
            }

            sortedMonths.forEach(([id, data]) => {
                const isHidden = data.isVisible === false;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-bold text-lg">${data.title}</span>
                        <span class="text-xs text-gray-500 block">ID: ${id}</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-secondary edit-month-title-btn" data-id="${id}" title="Editar Título"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm ${isHidden ? 'btn-primary' : 'btn-secondary'} toggle-month-vis-btn" data-id="${id}" title="${isHidden ? 'Mostrar' : 'Ocultar'}"><i class="fas ${isHidden ? 'fa-eye-slash' : 'fa-eye'}"></i></button>
                        <button class="btn btn-sm btn-danger delete-month-btn" data-id="${id}" title="Excluir Mês"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderMenuManagement() {
            const container = document.getElementById('menu-management-list');
            container.innerHTML = '';
            Object.entries(menuSettings).sort(([, a], [, b]) => a.order - b.order).forEach(([key, value], index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                div.dataset.key = key;
                div.innerHTML = `<div class="flex-grow"><label class="block text-sm font-medium text-gray-500">Nome</label><input type="text" value="${value.name}" class="input-field menu-item-name mt-1"></div><div class="flex items-center space-x-3 ml-4"><div class="flex flex-col items-center"><label class="text-sm font-medium text-gray-500">Visível</label><label class="switch mt-1"><input type="checkbox" class="menu-item-visible" ${value.isVisible ? 'checked' : ''}><span class="slider"></span></label></div><div class="flex flex-col"><button class="btn btn-secondary btn-sm p-1 move-up"><i class="fas fa-arrow-up"></i></button><button class="btn btn-secondary btn-sm p-1 move-down"><i class="fas fa-arrow-down"></i></button></div></div>`;
                container.appendChild(div);
            });
        }

        function renderResultsForm(monthId) {
            const grid = document.getElementById('stages-grid');
            if(grid) grid.innerHTML = '';
            if (!monthId || !monthlyData[monthId]) {
                if(grid) grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Este mês ainda não foi criado. Clique em "Novo Mês".</p>';
                document.getElementById('month-completed-checkbox').checked = false;
                document.getElementById('geral_podium_img').value = '';
                return;
            }
            let data = monthlyData[monthId];
            document.getElementById('month-completed-checkbox').checked = data.isCompleted || false;
            document.getElementById('geral_podium_img').value = data.geral_podium_img || '';

            (data.stages || []).forEach((stage, index) => {
                const stageId = stage.id || `temp_${index}`;
                let statusBg = 'bg-gray-100 hover:bg-gray-200';
                if (stage.status === 'Realizada') statusBg = 'bg-green-100 hover:bg-green-200';
                else if (stage.status === 'Cancelada') statusBg = 'bg-red-100 hover:bg-red-200';
                else if (stage.status === 'Adiada') statusBg = 'bg-yellow-100 hover:bg-yellow-200';
                else if (stage.status === 'A realizar') statusBg = 'bg-blue-100 hover:bg-blue-200';

                const button = document.createElement('button');
                button.className = `p-4 rounded-lg shadow ${statusBg} text-left transition`;
                button.innerHTML = `<p class="font-bold text-lg">${stage.name || `Etapa ${index + 1}`}</p><p class="text-sm text-gray-600">${stage.date || 'Sem data'}</p><span class="text-xs font-semibold">${stage.status || 'Não definida'}</span>`;
                button.onclick = () => openStageEditModal(monthId, stageId, index);
                grid.appendChild(button);
            });

             const addButton = document.createElement('button');
             addButton.className = 'p-4 rounded-lg shadow bg-white hover:bg-gray-50 text-left transition border-2 border-dashed border-gray-300 text-gray-500 flex items-center justify-center font-bold';
             addButton.innerHTML = `<i class="fas fa-plus mr-2"></i> Adicionar Nova Etapa`;
             addButton.onclick = () => openStageEditModal(monthId, null, -1);
             grid.appendChild(addButton);
        }

        function openStageEditModal(monthId, stageId, stageIndex) {
            const modal = document.getElementById('stage-edit-modal');
            const form = document.getElementById('stage-edit-form');
            form.reset();
            
            const month = monthlyData[monthId];
            let stage = { id: `new_stage_${Date.now()}`, status: 'A realizar', results: [] };

            if(stageId) {
                stage = month.stages.find(s => s.id === stageId) || month.stages[stageIndex];
                modal.querySelector('#stage-modal-title').textContent = "Editar Etapa";
                form.querySelector('#edit-stage-index').value = stageIndex;
            } else {
                modal.querySelector('#stage-modal-title').textContent = "Adicionar Nova Etapa";
                form.querySelector('#edit-stage-index').value = -1;
            }

            form.querySelector('#edit-stage-id').value = stage.id;
            form.querySelector('#edit-stage-month-id').value = monthId;
            form.querySelector('#edit-stage-name').value = stage.name || '';
            form.querySelector('#edit-stage-date').value = stage.date || '';
            form.querySelector('#edit-stage-type').value = stage.type || '';
            form.querySelector('#edit-stage-duration-distance').value = stage.durationDistance || '';
            form.querySelector('#edit-stage-podium-img').value = stage.podium_img || '';

            populateStageModalLists(stage);
            renderStageStatusButtons(stage.status || 'A realizar');
            openModal('stage-edit-modal');
        }

        function populateStageModalLists(stage) {
            const availableList = document.getElementById('edit-stage-available-list');
            const classifiedList = document.getElementById('edit-stage-classified-list');
            availableList.innerHTML = '';
            classifiedList.innerHTML = '';

            const stageResultsIds = (stage.results || []).map(p => p.id || nameToIdMap[p.name?.toUpperCase()]).filter(Boolean);

            Object.entries(participantsData)
                .filter(([id, p]) => p.isActive !== false && !stageResultsIds.includes(id))
                .sort((a, b) => a[1].name.localeCompare(b[1].name))
                .forEach(([id, p]) => {
                    availableList.innerHTML += `<div class="participant-item available-participant" data-id="${id}" data-name="${p.name.toLowerCase()}"><span>${p.name.toUpperCase()}</span><button type="button" class="text-green-500 hover:text-green-700 add-participant-to-stage-btn"><i class="fas fa-plus-circle"></i></button></div>`;
                });

            stageResultsIds.forEach((id, idx) => {
                const p = participantsData[id];
                if (p) classifiedList.innerHTML += `<div class="participant-item classified-participant" data-id="${id}"><span>${idx + 1}. ${p.name.toUpperCase()}</span><div class="space-x-2"><button type="button" class="text-gray-500 hover:text-gray-700 move-up-btn"><i class="fas fa-arrow-up"></i></button><button type="button" class="text-gray-500 hover:text-gray-700 move-down-btn"><i class="fas fa-arrow-down"></i></button><button type="button" class="text-red-500 hover:text-red-700 remove-participant-from-stage-btn"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }
        
        function renderStageStatusButtons(currentStatus) {
            const container = document.getElementById('stage-status-buttons');
            container.innerHTML = '';
            const statuses = [{ id: 'A realizar', text: 'A Realizar' }, { id: 'Realizada', text: 'Realizada' }, { id: 'Cancelada', text: 'Cancelada' }, { id: 'Adiada', text: 'Adiada' }];
            
            statuses.forEach(status => {
                const isActive = status.id === currentStatus;
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.status = status.id;
                button.textContent = status.text;
                button.className = `btn status-toggle-btn text-sm py-1 px-2 ${isActive ? 'btn-primary' : 'btn-secondary'}`;
                if(isActive) button.disabled = true;
                container.appendChild(button);
            });
        }
        
        function getStageDataFromModal() {
            const form = document.getElementById('stage-edit-form');
            const classifiedIds = [];
            form.querySelectorAll('#edit-stage-classified-list .classified-participant').forEach(item => classifiedIds.push(item.dataset.id));
            const activeStatusBtn = form.querySelector('.status-toggle-btn.btn-primary');
            return {
                id: form.querySelector('#edit-stage-id').value,
                name: form.querySelector('#edit-stage-name').value.trim(),
                date: form.querySelector('#edit-stage-date').value,
                type: form.querySelector('#edit-stage-type').value,
                durationDistance: form.querySelector('#edit-stage-duration-distance').value.trim(),
                podium_img: form.querySelector('#edit-stage-podium-img').value.trim(),
                results: classifiedIds.map(id => ({ id })),
                status: activeStatusBtn ? activeStatusBtn.dataset.status : 'A realizar',
                motive: '' 
            };
        }

        async function saveFullMonthData(monthId) {
            const stages = monthlyData[monthId]?.stages || [];
            const isCompleted = document.getElementById('month-completed-checkbox').checked;
            const geralPodiumImg = document.getElementById('geral_podium_img').value.trim();
            try {
                const dataToSave = { 
                    title: monthlyData[monthId]?.title, 
                    stages, isCompleted, geral_podium_img: geralPodiumImg,
                    isVisible: monthlyData[monthId]?.isVisible !== false // Persist visibility
                };
                await setDoc(doc(db, 'results', monthId), dataToSave, { merge: true });
                monthlyData[monthId] = dataToSave;
                return true;
            } catch (error) {
                console.error("Erro ao guardar:", error);
                openInfoModal("Erro ao guardar.");
                return false;
            }
        }
        
        async function loadAllData() {
            try {
                const [pSnap, rSnap, settingsSnap, logsSnap, tSnap, nSnap, menuSnap] = await Promise.all([
                    getDocs(collection(db, "participants")), getDocs(collection(db, "results")), getDoc(doc(db, "settings", "config")),
                    getDocs(query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(100))), getDocs(collection(db, "teams")),
                    getDocs(query(collection(db, "noticias"), orderBy("createdAt", "desc"))), getDoc(doc(db, "settings", "menu"))
                ]);
                
                participantsData = {}; nameToIdMap = {};
                pSnap.forEach(doc => { const d = doc.data(); if (d.name) { participantsData[doc.id] = d; nameToIdMap[d.name.toUpperCase()] = doc.id; } });
                monthlyData = {}; rSnap.forEach(doc => monthlyData[doc.id] = doc.data());
                teamsData = {}; tSnap.forEach(doc => teamsData[doc.id] = doc.data());

                if (settingsSnap.exists()) { const s = settingsSnap.data(); sporadicRiders = s.sporadicRiders || []; imageBaseUrl = s.imageBaseUrl || ''; document.getElementById('image-base-url').value = imageBaseUrl; document.getElementById('show-team-names').checked = s.showTeamNames !== false; }
                allLogs = []; logsSnap.forEach(doc => allLogs.push(doc.data()));
                noticiasData = []; nSnap.forEach(doc => noticiasData.push({ id: doc.id, ...doc.data() }));

                if (menuSnap.exists()) menuSettings = menuSnap.data();
                if (!menuSettings["historico.html"]) menuSettings["historico.html"] = { name: "Histórico", isVisible: true, order: 99 };

                renderParticipants(); renderMonthSelector(); renderTeamSelectors(); renderLogs(); renderTeamsList(); renderNoticias(); renderMenuManagement(); renderMonthsList();
                
                const initialMonth = document.getElementById('month-select-admin').value;
                if(initialMonth) renderResultsForm(initialMonth);

            } catch (error) { console.error(e); openInfoModal("Erro ao carregar dados."); }
        }
        
        function setupDashboardEventListeners() {
            quill = new Quill('#noticia-editor', { theme: 'snow', modules: { toolbar: [['bold', 'italic'], ['link', 'image']] } });
            document.getElementById('info-modal-close').addEventListener('click', () => closeModal('info-modal'));
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('admin-menu').addEventListener('click', (e) => {
                e.preventDefault(); const t = e.target.closest('a')?.dataset.target;
                if (t) {
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
                    document.querySelectorAll('.admin-menu-item').forEach(i => i.classList.remove('active'));
                    document.getElementById(t).classList.remove('hidden');
                    e.target.closest('a').classList.add('active');
                }
            });
            
            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const btn = document.getElementById('save-settings-btn'); btn.disabled = true; btn.textContent = 'A guardar...';
                try {
                    await setDoc(doc(db, "settings", "config"), { imageBaseUrl: document.getElementById('image-base-url').value.trim(), showTeamNames: document.getElementById('show-team-names').checked }, { merge: true });
                    await logAction('SETTINGS_UPDATED', `Configurações atualizadas.`);
                    openInfoModal('Guardado!');
                } catch (e) { openInfoModal('Erro ao guardar.'); } finally { btn.disabled = false; btn.textContent = 'Guardar Configurações'; }
            });

            // Menu Move Logic
            const updateMenuBtns = () => {
                const items = document.querySelectorAll('#menu-management-list .flex');
                items.forEach((item, index) => {
                    item.querySelector('.move-up').disabled = (index === 0);
                    item.querySelector('.move-down').disabled = (index === items.length - 1);
                });
            };
            document.getElementById('menu-management-list').addEventListener('click', (e) => {
                const up = e.target.closest('.move-up'), down = e.target.closest('.move-down'), item = e.target.closest('.flex[data-key]');
                if (up && item?.previousElementSibling) { item.parentElement.insertBefore(item, item.previousElementSibling); updateMenuBtns(); }
                else if (down && item?.nextElementSibling) { item.parentElement.insertBefore(item.nextElementSibling, item); updateMenuBtns(); }
            });
            document.getElementById('save-menu-btn').addEventListener('click', async () => {
                const newMenu = {};
                document.querySelectorAll('#menu-management-list .flex[data-key]').forEach((item, i) => {
                    newMenu[item.dataset.key] = { name: item.querySelector('.menu-item-name').value, isVisible: item.querySelector('.menu-item-visible').checked, order: i + 1 };
                });
                await setDoc(doc(db, "settings", "menu"), newMenu);
                menuSettings = newMenu;
                openInfoModal('Menu atualizado!');
            });

            document.getElementById('month-select-admin').addEventListener('change', (e) => renderResultsForm(e.target.value));
            
            document.getElementById('save-month-settings-btn').addEventListener('click', async () => {
                const mid = document.getElementById('month-select-admin').value;
                if(await saveFullMonthData(mid)) openInfoModal('Mês guardado!');
            });
            
            document.getElementById('stage-edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const mid = document.getElementById('edit-stage-month-id').value;
                const idx = document.getElementById('edit-stage-index').value;
                const newData = getStageDataFromModal();
                if (idx == -1) monthlyData[mid].stages.push(newData); else monthlyData[mid].stages[idx] = newData;
                if (await saveFullMonthData(mid)) { closeModal('stage-edit-modal'); renderResultsForm(mid); openInfoModal('Etapa guardada!'); }
            });

             document.getElementById('stage-edit-modal').addEventListener('click', async (e) => {
                const btn = e.target.closest('button'); if (!btn) return;
                const pItem = btn.closest('.participant-item');
                if (btn.classList.contains('add-participant-to-stage-btn')) {
                   const list = document.getElementById('edit-stage-classified-list');
                   const div = document.createElement('div'); div.className = 'participant-item classified-item'; div.dataset.id = pItem.dataset.id;
                   div.innerHTML = `<span>${pItem.querySelector('span').textContent}</span><div class="space-x-2"><button type="button" class="text-gray-500 hover:text-gray-700 move-up-btn"><i class="fas fa-arrow-up"></i></button><button type="button" class="text-gray-500 hover:text-gray-700 move-down-btn"><i class="fas fa-arrow-down"></i></button><button type="button" class="text-red-500 hover:text-red-700 remove-participant-from-stage-btn"><i class="fas fa-trash"></i></button></div>`;
                   list.appendChild(div); pItem.remove();
                } else if (btn.classList.contains('remove-participant-from-stage-btn')) {
                   const list = document.getElementById('edit-stage-available-list');
                   const div = document.createElement('div'); div.className = 'participant-item available-participant'; div.dataset.id = pItem.dataset.id; div.dataset.name = participantsData[pItem.dataset.id].name.toLowerCase();
                   div.innerHTML = `<span>${participantsData[pItem.dataset.id].name.toUpperCase()}</span><button type="button" class="text-green-500 hover:text-green-700 add-participant-to-stage-btn"><i class="fas fa-plus-circle"></i></button>`;
                   list.appendChild(div); pItem.remove();
                } else if (btn.classList.contains('move-up-btn')) {
                   if(pItem.previousElementSibling) pItem.parentElement.insertBefore(pItem, pItem.previousElementSibling);
                } else if (btn.classList.contains('move-down-btn')) {
                   if(pItem.nextElementSibling) pItem.parentElement.insertBefore(pItem.nextElementSibling, pItem);
                } else if (btn.classList.contains('status-toggle-btn')) {
                    document.querySelectorAll('.status-toggle-btn').forEach(b => { b.classList.replace('btn-primary', 'btn-secondary'); b.disabled = false; });
                    btn.classList.replace('btn-secondary', 'btn-primary'); btn.disabled = true;
                } else if (btn.id === 'remove-stage-btn') {
                    if(await openConfirmModal('Remover etapa?')) {
                        const mid = document.getElementById('edit-stage-month-id').value;
                        const sid = document.getElementById('edit-stage-id').value;
                        monthlyData[mid].stages = monthlyData[mid].stages.filter(s => s.id !== sid);
                        await saveFullMonthData(mid); closeModal('stage-edit-modal'); renderResultsForm(mid);
                    }
                }
            });
            
            document.getElementById('edit-stage-filter').addEventListener('input', (e) => {
                 const val = e.target.value.toLowerCase();
                 document.querySelectorAll('#edit-stage-available-list .available-participant').forEach(i => i.style.display = i.dataset.name.includes(val) ? 'flex' : 'none');
            });
            
            document.getElementById('new-month-btn').addEventListener('click', async () => {
                const mid = await openPromptModal("ID do Mês (AAAA_MM):"); if(!mid) return;
                const title = await openPromptModal("Título (ex: Out/2025):"); if(!title) return;
                const [y, m] = mid.split('_').map(Number);
                const stages = [];
                const d = new Date(y, m-1, 1);
                while(d.getMonth() === m-1) {
                    if(d.getDay() === 4) stages.push({id: `stg_${d.getTime()}`, name: `Etapa ${stages.length+1}`, date: d.toISOString().split('T')[0], type:'Circuito', durationDistance:'55min', podium_img:'', status:'A realizar', results:[]});
                    d.setDate(d.getDate()+1);
                }
                await setDoc(doc(db, 'results', mid), {title, stages, isCompleted:false, geral_podium_img:'', isVisible: true});
                openInfoModal("Mês criado!"); loadAllData();
            });

             // Management of Months (Edit Title, Toggle Vis, Delete)
             document.getElementById('months-list-container').addEventListener('click', async (e) => {
                const btn = e.target.closest('button');
                if(!btn) return;
                const mid = btn.dataset.id;

                if(btn.classList.contains('edit-month-title-btn')) {
                    const newTitle = await openPromptModal('Novo Título:', monthlyData[mid].title);
                    if(newTitle) {
                        monthlyData[mid].title = newTitle;
                        await saveFullMonthData(mid);
                        renderMonthsList();
                        renderMonthSelector(); // Update dropdown
                    }
                } else if(btn.classList.contains('toggle-month-vis-btn')) {
                    monthlyData[mid].isVisible = !monthlyData[mid].isVisible;
                    await saveFullMonthData(mid); // saveFullMonthData handles isVisible persistence now
                    renderMonthsList();
                } else if(btn.classList.contains('delete-month-btn')) {
                    if(await openConfirmModal(`Apagar ${monthlyData[mid].title} para sempre?`)) {
                        await deleteDoc(doc(db, 'results', mid));
                        delete monthlyData[mid];
                        renderMonthsList();
                        renderMonthSelector();
                        renderResultsForm(document.getElementById('month-select-admin').value);
                    }
                }
             });

            // Participants, Teams, News Listeners (Abbreviated - logic is same)
            document.getElementById('filter-team').onchange = renderParticipants;
            document.getElementById('filter-name').oninput = renderParticipants;
            
             // Moderação de Comentários
            document.querySelectorAll('.moderate-comments-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const newsId = btn.dataset.id;
                    const q = query(collection(db, 'comments'), where('newsId', '==', newsId));
                    const snap = await getDocs(q);
                    const container = document.getElementById('comments-list-container');
                    container.innerHTML = snap.empty ? '<p>Sem comentários.</p>' : '';
                    openModal('comments-modal');
                    
                    snap.forEach(docSnap => {
                        const c = docSnap.data();
                        const div = document.createElement('div');
                        div.className = `p-3 rounded-lg mb-2 flex justify-between ${c.isActive ? 'bg-white border' : 'bg-red-50 border border-red-200'}`;
                        div.innerHTML = `<div><p class="font-bold">${c.name}</p><p class="text-sm">${c.text}</p></div><button class="btn btn-sm ${c.isActive ? 'btn-danger' : 'btn-secondary'}" onclick="toggleCommentStatus('${docSnap.id}', ${c.isActive})">${c.isActive ? 'Inativar' : 'Ativar'}</button>`;
                        container.appendChild(div);
                    });
                });
            });
             window.toggleCommentStatus = async (id, current) => {
                await updateDoc(doc(db, 'comments', id), { isActive: !current });
                // close and reopen or dynamic update would be better, for now simple close
                closeModal('comments-modal'); openInfoModal('Status atualizado.');
            };
            // ... (News Add/Edit/Delete listeners) ...
            document.getElementById('add-noticia-form').onsubmit = async (e) => { e.preventDefault(); const t=document.getElementById('noticia-title').value, i=document.getElementById('noticia-image').value, c=quill.root.innerHTML, id=document.getElementById('noticia-id').value; await (id ? updateDoc(doc(db,'noticias',id),{title:t,imageUrl:i,content:c,updatedAt:serverTimestamp()}) : addDoc(collection(db,'noticias'),{title:t,imageUrl:i,content:c,createdAt:serverTimestamp()})); document.getElementById('add-noticia-form').reset(); quill.root.innerHTML=''; loadAllData(); openInfoModal('Salvo!'); };
            // ...
        }
        
        // --- Auth & Entry ---
        async function init() {
             onAuthStateChanged(auth, (user) => { if (user) showDashboard(); else showLogin(); });
        }
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
